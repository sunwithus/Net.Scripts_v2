@*ReplicatorOra.razor*@

@page "/oracle-replicator"
@rendermode InteractiveServer

@using Microsoft.EntityFrameworkCore
@using System.Text.Json
@using System.ComponentModel

@using MudBlazorWeb2.Components.EntityFrameworkCore
@using MudBlazorWeb2.Components.Modules.Replicator.Services
@using MudBlazorWeb2.Components.Modules.Replicator
@using MudBlazorWeb2.Components.Modules._Shared
@inject IDbContextFactory<OracleDbContext> DbFactory
@inject IConfiguration Configuration 
@inject SettingsService SettingsService
@inject ReplSingletonService ReplSingleton

<PageTitle>🛢 Replicator Ora</PageTitle>

<MudContainer>
    <MudText Typo="Typo.h5">Аудио в Oracle 🎧 => 📦</MudText>
    <MudDivider />
    <br />

    <MudOverlay Visible="!ReplSingleton.IsStoped" LightBackground="true" Absolute="true" Style="height: 100%;">
        <MudText>Процесс занят.</MudText>
        <MudText>Идёт выполнение, подождите... @ReplSingleton.ProgressExec %</MudText>
    </MudOverlay>

    <OracleConnectionSettings colorButton="@colorButton" OnSettingsChanged="OnSettingsChanged" settingsDB="@settingsDB" oraItemsDB="@settingsDB.SettingsReplicator.OraItems" propertyName="SettingsReplicator" />

    <MudText Style="width: 325px;">
        <OracleChooseOperator colorButton="@colorButton" OnOperatorSelected="HandleOperatorSelected" />
    </MudText>

    @if (!string.IsNullOrEmpty(operatorName))
    {
        <LoadManyFilesFromFolder pathToSaveTempAudio="@pathToSaveTempAudio" onlyAudioType="@true" colorButton="@colorButton" OnFinishLoading="HandleFilesLoaded" />
    }

    else
    {
        <MudText Typo="Typo.body1" Color="@colorButton">Выберите значение "Оператор"</MudText>
    }

    <br />

    @if (isFilesLoaded)
    {
        <OracleAudioReplication pathToAudio="@pathToSaveTempAudio" sourceName="@operatorName" colorButton="@colorButton" IsReplicationFinished="HandleReplicationIsFinished" OnPercentsProgress="HandlePercentsProgress" />
    }

 </MudContainer>


@code {

    MudBlazor.Color colorButton = Color.Surface;
    private string pathToSaveTempAudio = "";
    private string operatorName = ""; //имя источник
    private bool isFilesLoaded = false;
    private Settings settingsDB = null;

    protected override async Task OnInitializedAsync()
    {
        ReplSingleton.PropertyChanged += Singleton_PropertyChanged;
        await base.OnInitializedAsync();

        pathToSaveTempAudio = Configuration["AudioPathForReplicator"] + Guid.NewGuid() +"\\";
        settingsDB = SettingsService.GetSettings();
    }


    private async Task OnSettingsChanged()
    {
        await Task.Delay(1);
        Console.WriteLine("Настройки подключения к БД для репликатора изменились");
        settingsDB = SettingsService.GetSettings();
    }

    private void HandleOperatorSelected(string value)
    {
        operatorName = value;
        Console.WriteLine($"HandleOperatorSelected: {operatorName}");
        StateHasChanged();
    }

    private void HandleFilesLoaded(bool value)
    {
        isFilesLoaded = value;
        Console.WriteLine($"HandleFilesLoaded: Файлы загружены: {value}");
    }

    private void HandleReplicationIsFinished (bool value)
    {
        ReplSingleton.IsStoped = value;
    }

    private void HandlePercentsProgress(int PercentsProgress)
    {
        ReplSingleton.ProgressExec = PercentsProgress;
        StateHasChanged();
    }

    private void Singleton_PropertyChanged(object sender, PropertyChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

}